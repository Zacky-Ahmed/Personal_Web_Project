<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up | GemBro</title>
    <meta name="description" content="Create your GemBro account to access seller dashboard and premium features.">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-container">
            <a href="index.html" class="nav-logo">
                <div class="logo-icon">
                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M16 2L6 10L16 30L26 10L16 2Z" fill="url(#signupLogoGradient)"/>
                        <path d="M16 2L10 8L16 14L22 8L16 2Z" fill="url(#signupLogoGradient2)"/>
                        <defs>
                            <linearGradient id="signupLogoGradient" x1="16" y1="2" x2="16" y2="30" gradientUnits="userSpaceOnUse">
                                <stop offset="0%" stop-color="#6366f1"/>
                                <stop offset="50%" stop-color="#8b5cf6"/>
                                <stop offset="100%" stop-color="#ec4899"/>
                            </linearGradient>
                            <linearGradient id="signupLogoGradient2" x1="16" y1="2" x2="16" y2="14" gradientUnits="userSpaceOnUse">
                                <stop offset="0%" stop-color="#ffffff" stop-opacity="0.3"/>
                                <stop offset="100%" stop-color="#ffffff" stop-opacity="0"/>
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
                <span class="logo-text">GemBro</span>
            </a>
            <div class="nav-menu" id="navMenu">
                <a href="marketplace.html" class="nav-link">Marketplace</a>
                <a href="index.html#workflow" class="nav-link">How It Works</a>
                <a href="index.html#testimonials" class="nav-link">Reviews</a>
                <a href="contact.html" class="nav-link">Contact</a>
            </div>
            <div class="nav-actions">
                <a href="signup.html" class="btn-ghost">Sign Up</a>
                <a href="login.html" class="btn-ghost">Sign In</a>
                <a href="seller.html" class="btn-gradient">Become Seller</a>
            </div>
            <button class="nav-toggle" id="navToggle" aria-label="Toggle menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </nav>

    <!-- Signup Section -->
    <section class="seller-form-section" style="padding: 120px 0;">
        <div class="container">
            <div style="max-width: 450px; margin: 0 auto;">
                <div class="form-header" style="text-align: center; margin-bottom: 48px;">
                    <h2 style="font-size: 40px; font-weight: 700; margin-bottom: 12px;">Create Account</h2>
                    <p style="color: var(--text-secondary);">Sign up to get started with GemBro</p>
                </div>
                
                <form id="signupForm" class="seller-form" style="padding: 40px;">
                    <div class="form-group">
                        <label for="signupFullName" class="form-label">Full Name</label>
                        <input type="text" id="signupFullName" name="signupFullName" class="form-input" placeholder="John Doe" required>
                        <span class="form-error" id="signupFullNameError"></span>
                    </div>
                    
                    <div class="form-group">
                        <label for="signupEmail" class="form-label">Email Address</label>
                        <input type="email" id="signupEmail" name="signupEmail" class="form-input" placeholder="your@email.com" required>
                        <span class="form-error" id="signupEmailError"></span>
                    </div>

                    <div class="form-group" id="emailVerificationGroup">
                        <label class="form-label">Email Verification</label>
                        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 12px;">
                            <button type="button" id="sendVerificationCodeBtn" class="btn-gradient" style="padding: 10px 24px; font-size: 14px;">Send Verification Code</button>
                            <span id="verificationStatus" style="color: var(--text-secondary); font-size: 14px;"></span>
                        </div>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <input type="text" id="verificationCode" class="form-input" placeholder="Enter 4-digit code" maxlength="4" style="flex: 1 1 180px;" disabled>
                            <button type="button" id="verifyCodeBtn" class="btn-ghost" style="padding: 10px 24px; font-size: 14px;" disabled>Verify Code</button>
                        </div>
                        <span class="form-error" id="verificationCodeError"></span>
                    </div>
                    
                    <div class="form-group">
                        <label for="signupPhone" class="form-label">Phone Number</label>
                        <input type="tel" id="signupPhone" name="signupPhone" class="form-input" placeholder="+1 234 567 8900">
                        <span class="form-error" id="signupPhoneError"></span>
                    </div>
                    
                    <div class="form-group">
                        <label for="signupPassword" class="form-label">Password</label>
                        <input type="password" id="signupPassword" name="signupPassword" class="form-input" placeholder="Enter your password" required disabled>
                        <span class="form-error" id="signupPasswordError"></span>
                    </div>
                    
                    <div class="form-group">
                        <label for="signupConfirmPassword" class="form-label">Confirm Password</label>
                        <input type="password" id="signupConfirmPassword" name="signupConfirmPassword" class="form-input" placeholder="Confirm your password" required disabled>
                        <span class="form-error" id="signupConfirmPasswordError"></span>
                    </div>
                    
                    <div class="form-actions" style="margin-top: 32px;">
                        <button type="submit" class="btn-primary-large" style="width: 100%;">
                            <span id="signupSubmitText">Create Account</span>
                        </button>
                        <p class="form-success" id="signupSuccessMessage"></p>
                        <p class="form-error" id="signupErrorMessage"></p>
                    </div>
                    
                    <div style="text-align: center; margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-color);">
                        <p style="color: var(--text-secondary); font-size: 14px;">
                            Already have an account? <a href="login.html" style="color: var(--primary-light); text-decoration: none; font-weight: 500;">Sign In</a>
                        </p>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <div class="footer-logo">
                        <div class="logo-icon">
                            <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M16 2L6 10L16 30L26 10L16 2Z" fill="url(#signupFooterLogoGradient)"/>
                                <path d="M16 2L10 8L16 14L22 8L16 2Z" fill="url(#signupFooterLogoGradient2)"/>
                                <defs>
                                    <linearGradient id="signupFooterLogoGradient" x1="16" y1="2" x2="16" y2="30" gradientUnits="userSpaceOnUse">
                                        <stop offset="0%" stop-color="#6366f1"/>
                                        <stop offset="50%" stop-color="#8b5cf6"/>
                                        <stop offset="100%" stop-color="#ec4899"/>
                                    </linearGradient>
                                    <linearGradient id="signupFooterLogoGradient2" x1="16" y1="2" x2="16" y2="14" gradientUnits="userSpaceOnUse">
                                        <stop offset="0%" stop-color="#ffffff" stop-opacity="0.3"/>
                                        <stop offset="100%" stop-color="#ffffff" stop-opacity="0"/>
                                    </linearGradient>
                                </defs>
                            </svg>
                        </div>
                        <span class="logo-text">GemBro</span>
                    </div>
                    <p class="footer-description">Connecting gem experts with global buyers through authenticity, transparency, and premium support.</p>
                </div>
                <div class="footer-links">
                    <div class="footer-column">
                        <h4>Company</h4>
                        <a href="about.html">About</a>
                        <a href="#">Privacy Policy</a>
                        <a href="#">Terms of Service</a>
                    </div>
                    <div class="footer-column">
                        <h4>Resources</h4>
                        <a href="#">Seller Handbook</a>
                        <a href="contact.html">Support</a>
                        <a href="#">Documentation</a>
                    </div>
                    <div class="footer-column">
                        <h4>Contact</h4>
                        <a href="mailto:hello@gemmarket.app">hello@gemmarket.app</a>
                        <a href="tel:+94771234567">+94 77 123 4567</a>
                    </div>
                </div>
                <div class="footer-newsletter">
                    <h4>Stay Updated</h4>
                    <div class="newsletter-form">
                        <input type="email" placeholder="Enter your email" class="newsletter-input">
                        <button class="newsletter-btn">Subscribe</button>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; <span id="currentYear"></span> GemBro. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="script.js"></script>
    <script>
        // Signup form handling with email verification
        document.addEventListener('DOMContentLoaded', function() {
            const signupForm = document.getElementById('signupForm');
            const signupEmail = document.getElementById('signupEmail');
            const passwordInput = document.getElementById('signupPassword');
            const confirmPasswordInput = document.getElementById('signupConfirmPassword');
            const sendVerificationCodeBtn = document.getElementById('sendVerificationCodeBtn');
            const verifyCodeBtn = document.getElementById('verifyCodeBtn');
            const verificationCodeInput = document.getElementById('verificationCode');
            const verificationCodeError = document.getElementById('verificationCodeError');
            const verificationStatus = document.getElementById('verificationStatus');

            let isEmailVerified = false;
            let verifiedEmail = '';
            let resendInterval = null;

            const togglePasswordFields = (enabled) => {
                passwordInput.disabled = !enabled;
                confirmPasswordInput.disabled = !enabled;
                if (!enabled) {
                    passwordInput.value = '';
                    confirmPasswordInput.value = '';
                }
            };

            const resetVerificationState = () => {
                isEmailVerified = false;
                verifiedEmail = '';
                verificationCodeInput.value = '';
                verificationCodeInput.disabled = true;
                verifyCodeBtn.disabled = true;
                verificationStatus.textContent = '';
                verificationStatus.style.color = 'var(--text-secondary)';
                verificationCodeError.classList.remove('show');
                verificationCodeError.textContent = '';
                if (resendInterval) {
                    clearInterval(resendInterval);
                    resendInterval = null;
                }
                sendVerificationCodeBtn.disabled = false;
                sendVerificationCodeBtn.textContent = 'Send Verification Code';
                togglePasswordFields(false);
            };

            const startResendCountdown = (seconds) => {
                let remaining = seconds;
                sendVerificationCodeBtn.disabled = true;
                sendVerificationCodeBtn.textContent = `Resend in ${remaining}s`;
                resendInterval = setInterval(() => {
                    remaining -= 1;
                    if (remaining <= 0) {
                        clearInterval(resendInterval);
                        resendInterval = null;
                        sendVerificationCodeBtn.disabled = false;
                        sendVerificationCodeBtn.textContent = 'Resend Code';
                    } else {
                        sendVerificationCodeBtn.textContent = `Resend in ${remaining}s`;
                    }
                }, 1000);
            };

            const markEmailVerified = () => {
                isEmailVerified = true;
                verifiedEmail = signupEmail.value.trim();
                verificationStatus.textContent = 'Email verified!';
                verificationStatus.style.color = 'var(--success)';
                verificationCodeError.classList.remove('show');
                verificationCodeInput.disabled = true;
                verifyCodeBtn.disabled = true;
                sendVerificationCodeBtn.disabled = true;
                togglePasswordFields(true);
            };

            signupEmail.addEventListener('input', () => {
                if (signupEmail.value.trim().toLowerCase() !== verifiedEmail.toLowerCase()) {
                    resetVerificationState();
                }
            });

            sendVerificationCodeBtn.addEventListener('click', () => {
                const email = signupEmail.value.trim();
                document.getElementById('signupEmailError').classList.remove('show');
                document.getElementById('signupEmailError').textContent = '';
                verificationCodeError.classList.remove('show');
                verificationCodeError.textContent = '';

                if (!email) {
                    document.getElementById('signupEmailError').textContent = 'Please enter an email address.';
                    document.getElementById('signupEmailError').classList.add('show');
                    return;
                }
                if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    document.getElementById('signupEmailError').textContent = 'Please enter a valid email address.';
                    document.getElementById('signupEmailError').classList.add('show');
                    return;
                }

                sendVerificationCodeBtn.disabled = true;
                sendVerificationCodeBtn.textContent = 'Sending...';
                fetch('/api/auth/send-verification-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(errorData => {
                                throw new Error(errorData.error || 'Failed to send verification code');
                            }).catch(() => {
                                throw new Error('Failed to send verification code. Please try again.');
                            });
                        }
                        return response.json();
                    })
                    .then(() => {
                        verificationStatus.textContent = 'Verification code sent! Please check your email.';
                        verificationStatus.style.color = 'var(--text-secondary)';
                        verificationCodeInput.disabled = false;
                        verifyCodeBtn.disabled = false;
                        startResendCountdown(60);
                    })
                    .catch(error => {
                        verificationCodeError.textContent = error.message;
                        verificationCodeError.classList.add('show');
                        sendVerificationCodeBtn.disabled = false;
                        sendVerificationCodeBtn.textContent = 'Send Verification Code';
                    });
            });

            verifyCodeBtn.addEventListener('click', () => {
                const email = signupEmail.value.trim();
                const code = verificationCodeInput.value.trim();
                verificationCodeError.classList.remove('show');
                verificationCodeError.textContent = '';

                if (!code || code.length !== 4) {
                    verificationCodeError.textContent = 'Please enter the 4-digit verification code.';
                    verificationCodeError.classList.add('show');
                    return;
                }

                verifyCodeBtn.disabled = true;
                verificationStatus.textContent = 'Verifying code...';
                verificationStatus.style.color = 'var(--text-secondary)';

                fetch('/api/auth/verify-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, code })
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(errorData => {
                                throw new Error(errorData.error || 'Invalid or expired code');
                            }).catch(() => {
                                throw new Error('Verification failed. Please try again.');
                            });
                        }
                        return response.json();
                    })
                    .then(() => {
                        markEmailVerified();
                    })
                    .catch(error => {
                        verificationCodeError.textContent = error.message;
                        verificationCodeError.classList.add('show');
                        verificationStatus.textContent = '';
                        verificationStatus.style.color = 'var(--text-secondary)';
                        verifyCodeBtn.disabled = false;
                    });
            });

            if (signupForm) {
                signupForm.addEventListener('submit', function(e) {
                    e.preventDefault();

                    // Clear previous errors
                    document.querySelectorAll('#signupForm .form-error').forEach(error => {
                        error.classList.remove('show');
                        error.textContent = '';
                    });

                    const submitBtn = signupForm.querySelector('button[type="submit"]');
                    const submitText = document.getElementById('signupSubmitText');
                    const successMessage = document.getElementById('signupSuccessMessage');
                    const errorMessage = document.getElementById('signupErrorMessage');

                    // Hide previous messages
                    if (successMessage) {
                        successMessage.classList.remove('show');
                        successMessage.textContent = '';
                    }
                    if (errorMessage) {
                        errorMessage.classList.remove('show');
                        errorMessage.textContent = '';
                    }

                    // Get form values
                    const fullName = document.getElementById('signupFullName').value.trim();
                    const email = signupEmail.value.trim();
                    const phoneNumber = document.getElementById('signupPhone').value.trim();
                    const password = passwordInput.value;
                    const confirmPassword = confirmPasswordInput.value;

                    // Validation
                    let isValid = true;

                    if (!fullName) {
                        document.getElementById('signupFullNameError').textContent = 'Full name is required.';
                        document.getElementById('signupFullNameError').classList.add('show');
                        isValid = false;
                    }

                    if (!email) {
                        document.getElementById('signupEmailError').textContent = 'Email is required.';
                        document.getElementById('signupEmailError').classList.add('show');
                        isValid = false;
                    } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                        document.getElementById('signupEmailError').textContent = 'Please enter a valid email address.';
                        document.getElementById('signupEmailError').classList.add('show');
                        isValid = false;
                    } else if (!isEmailVerified || verifiedEmail.toLowerCase() !== email.toLowerCase()) {
                        document.getElementById('signupEmailError').textContent = 'Please verify your email before creating an account.';
                        document.getElementById('signupEmailError').classList.add('show');
                        isValid = false;
                    }

                    if (!password) {
                        document.getElementById('signupPasswordError').textContent = 'Password is required.';
                        document.getElementById('signupPasswordError').classList.add('show');
                        isValid = false;
                    } else if (password.length < 6) {
                        document.getElementById('signupPasswordError').textContent = 'Password must be at least 6 characters long.';
                        document.getElementById('signupPasswordError').classList.add('show');
                        isValid = false;
                    }

                    if (!confirmPassword) {
                        document.getElementById('signupConfirmPasswordError').textContent = 'Please confirm your password.';
                        document.getElementById('signupConfirmPasswordError').classList.add('show');
                        isValid = false;
                    } else if (password !== confirmPassword) {
                        document.getElementById('signupConfirmPasswordError').textContent = 'Passwords do not match.';
                        document.getElementById('signupConfirmPasswordError').classList.add('show');
                        isValid = false;
                    }

                    if (!isValid) {
                        return;
                    }

                    // Disable submit button
                    submitBtn.disabled = true;
                    submitText.textContent = 'Creating Account...';

                    // Prepare user data
                    const userData = {
                        fullName: fullName,
                        email: email,
                        password: password
                    };

                    // Add phone number if provided
                    if (phoneNumber) {
                        userData.phoneNumber = phoneNumber;
                    }

                    // Submit to API
                    fetch('/api/users', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(userData)
                    })
                        .then(async response => {
                            const text = await response.text();
                            let payload = {};
                            if (text) {
                                try {
                                    payload = JSON.parse(text);
                                } catch (parseError) {
                                    console.error('Failed to parse signup response:', parseError, text);
                                }
                            }

                            if (!response.ok) {
                                throw new Error(payload.error || 'Failed to create account. Please try again.');
                            }

                            return payload;
                        })
                        .then(data => {
                            if (data.id || data.email) {
                                if (successMessage) {
                                    successMessage.textContent = 'Account created successfully! Redirecting to login...';
                                    successMessage.classList.add('show');
                                    successMessage.style.color = 'var(--success)';
                                }

                                setTimeout(() => {
                                    window.location.href = 'login.html';
                                }, 2000);
                            } else if (data.error) {
                                if (errorMessage) {
                                    errorMessage.textContent = data.error;
                                    errorMessage.classList.add('show');
                                }

                                if (data.error.toLowerCase().includes('email')) {
                                    document.getElementById('signupEmailError').textContent = data.error;
                                    document.getElementById('signupEmailError').classList.add('show');
                                }

                                submitBtn.disabled = false;
                                submitText.textContent = 'Create Account';
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            if (errorMessage) {
                                errorMessage.textContent = error.message || 'An error occurred. Please try again.';
                                errorMessage.classList.add('show');
                            }
                            submitBtn.disabled = false;
                            submitText.textContent = 'Create Account';
                        });
                });
            }

            // Set current year in footer
            const currentYearElement = document.getElementById('currentYear');
            if (currentYearElement) {
                currentYearElement.textContent = new Date().getFullYear();
            }

            resetVerificationState();
        });
    </script>
</body>
</html>

